<?xml version="1.0" encoding="UTF-8"?>
<!--
  - Logback配置文件。
-->
<configuration scan="false" scanPeriod="3600 seconds" debug="false">
    <!-- logger上下文,LOG_PATH是spring boot内置变量,取值logging.path -->
    <springProperty scope="context" name="APPLICATION_NAME" source="spring.application.name"/>
    <springProperty scope="context" name="LOGGING_ROOT" source="logging.path"/>
    <property name="PATTERN" value="%d [%t-${PID}] %-5p %c - [%m]%n"/>
    <property name="SEND_ES_FAIL_PATTERN" value="%d [%t-${PID}] %m%n"/>
    <property name="CONSOLE_LOG_PATTERN"
              value="%d [%boldYellow(%t-${PID})] %highlight(%-5p) %boldGreen(%c) - [%m]%n"/>


    <!-- [1,公共Appender] 控制台STDOUT -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder charset="UTF-8">
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- [1,公共Appender] 默认 -->
    <appender name="DEFAULT-APPENDER" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOGGING_ROOT}/common.log</file>
        <append>true</append>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- 日志文件输出的文件名 -->
            <FileNamePattern>${LOGGING_ROOT}/common/common.log.%d{yyyyMMdd}</FileNamePattern>
            <MaxHistory>20</MaxHistory>
        </rollingPolicy>
        <encoder charset="UTF-8">
            <pattern>${PATTERN}</pattern>
        </encoder>
    </appender>

    <!--canal-->
    <appender name="CANAL-ROOT" class="ch.qos.logback.classic.sift.SiftingAppender">
        <discriminator>
            <Key>destination</Key>
            <DefaultValue>canal</DefaultValue>
        </discriminator>
        <sift>
            <appender name="FILE-${destination}" class="ch.qos.logback.core.rolling.RollingFileAppender">
                <File>${LOGGING_ROOT}/canal/${destination}/${destination}.log</File>
                <rollingPolicy
                        class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                    <!-- rollover daily -->
                    <fileNamePattern>
                        ${LOGGING_ROOT}/canal/${destination}/%d{yyyy-MM-dd}/${destination}-%d{yyyy-MM-dd}-%i.log.gz
                    </fileNamePattern>
                    <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                        <!-- or whenever the file size reaches 100MB -->
                        <maxFileSize>512MB</maxFileSize>
                    </timeBasedFileNamingAndTriggeringPolicy>
                    <maxHistory>60</maxHistory>
                </rollingPolicy>
                <encoder>
                    <pattern>
                        %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{56} - %msg%n
                    </pattern>
                </encoder>
            </appender>
        </sift>
    </appender>

    <appender name="CANAL-META" class="ch.qos.logback.classic.sift.SiftingAppender">
        <discriminator>
            <Key>destination</Key>
            <DefaultValue>canal</DefaultValue>
        </discriminator>
        <sift>
            <appender name="META-FILE-${destination}" class="ch.qos.logback.core.rolling.RollingFileAppender">
                <File>${LOGGING_ROOT}/canal/${destination}/meta.log</File>
                <rollingPolicy
                        class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                    <!-- rollover daily -->
                    <fileNamePattern>${LOGGING_ROOT}/canal/${destination}/%d{yyyy-MM-dd}/meta-%d{yyyy-MM-dd}-%i.log.gz
                    </fileNamePattern>
                    <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                        <!-- or whenever the file size reaches 100MB -->
                        <maxFileSize>32MB</maxFileSize>
                    </timeBasedFileNamingAndTriggeringPolicy>
                    <maxHistory>60</maxHistory>
                </rollingPolicy>
                <encoder>
                    <pattern>
                        %d{yyyy-MM-dd HH:mm:ss.SSS} - %msg%n
                    </pattern>
                </encoder>
            </appender>
        </sift>
    </appender>

    <logger name="com.alibaba.otter.canal.instance" additivity="false">
        <level value="INFO"/>
        <appender-ref ref="CANAL-ROOT"/>
    </logger>
    <logger name="com.veelur.sync.canal" additivity="false">
        <level value="INFO"/>
        <appender-ref ref="CANAL-ROOT"/>
    </logger>
    <logger name="com.alibaba.otter.canal.meta.FileMixedMetaManager" additivity="false">
        <level value="INFO"/>
        <appender-ref ref="CANAL-META"/>
    </logger>

    <!-- 1,COMMON.LOG -->
    <logger name="com.veelur.sync" additivity="true">
        <level value="INFO"/>
        <appender-ref ref="DEFAULT-APPENDER"/>
    </logger>
    <logger name="com.alibaba" additivity="false">
        <level value="WARN"/>
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="CANAL-ROOT"/>
    </logger>
    <!-- ===================================================================== -->
    <!-- Root logger                                                           -->
    <!-- ===================================================================== -->
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
    <jmxConfigurator/>
</configuration>
